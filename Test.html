<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CombatLog Viewer Complet</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .player-card { background: #2a2a2a; padding: 20px; border-radius: 10px; }
        .player-name { font-size: 24px; font-weight: bold; color: #ffd700; margin-bottom: 15px; }
        .total-dps { font-size: 32px; color: #00ff88; font-weight: bold; }
        .ability-list { list-style: none; padding: 0; }
        .ability { background: #3a3a3a; margin: 8px 0; padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; }
        .ability-name { font-weight: bold; }
        .ability-dmg { color: #ff6b6b; }
        .top5 { background: linear-gradient(90deg, #ffd700, #ffed4a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #2a2a2a; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #3a3a3a; color: #ffd700; }
        .raw-log { background: #000; padding: 20px; border-radius: 10px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; }
        .upload-zone { background: #3a3a3a; padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• CombatLog Analyzer COMPLET üî•</h1>
        <p>Glisse ton <code>merged_logs.txt</code> ou clique pour uploader ‚Üí Stats instantan√©es !</p>
        <div id="stats"></div>
        <div id="global-table"></div>
        <div id="raw-log"></div>
    </div>

    <script>
        // PARSER COMBATLOG INT√âGR√â (100% autonome)
        function parseCombatLog(logText) {
            const stats = {};
            const lines = logText.split('\n').filter(line => line.trim());
            
            lines.forEach(line => {
                if (line.startsWith('CombatLogVersion')) return;
                const parts = line.split(',');
                if (parts.length < 11 || parts[1] !== 'DamageDone' || parseInt(parts[5]) === 0) return;
                
                const [, , ability, spellId, damage, , , , hitType, attacker, target] = parts;
                const dmg = parseInt(damage);
                
                if (!stats[attacker]) stats[attacker] = { total: 0, abilities: {} };
                if (!stats[attacker].abilities[ability]) stats[attacker].abilities[ability] = { total: 0, count: 0, avg: 0 };
                
                stats[attacker].total += dmg;
                stats[attacker].abilities[ability].total += dmg;
                stats[attacker].abilities[ability].count++;
                stats[attacker].abilities[ability].avg = stats[attacker].abilities[ability].total / stats[attacker].abilities[ability].count;
            });
            return stats;
        }

        function displayStats(stats) {
            const sortedPlayers = Object.entries(stats).sort(([,a], [,b]) => b.total - a.total);
            
            // TOP 5
            const top5Html = sortedPlayers.slice(0,5).map(([player, data], i) => 
                `<div class="player-card top5">
                    <div class="player-name">#${i+1} ${player}</div>
                    <div class="total-dps">${data.total.toLocaleString()} DPS</div>
                </div>`
            ).join('');
            
            document.getElementById('stats').innerHTML = `<div class="stats-grid">${top5Html}</div>`;
            
            // TABLEAU GLOBAL
            const tableRows = sortedPlayers.map(([player, data]) => {
                const topAbility = Object.entries(data.abilities).sort(([,a], [,b]) => b.total - a.total)[0];
                return `<tr>
                    <td>${player}</td>
                    <td>${data.total.toLocaleString()}</td>
                    <td>${topAbility ? topAbility[0] : 'N/A'}</td>
                    <td>${topAbility ? topAbility[1].total.toLocaleString() : '0'}</td>
                    <td>${Math.round(data.total / Object.keys(data.abilities).length || 0).toLocaleString()}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('global-table').innerHTML = `
                <table>
                    <thead><tr><th>Joueur</th><th>Total</th><th>Top Sort</th><th>Dmg Sort</th><th>/Sort</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table>
            `;
        }

        // DRAG & DROP + UPLOAD
        const uploadZone = document.createElement('div');
        uploadZone.className = 'upload-zone';
        uploadZone.innerHTML = `
            <input type="file" id="logFile" accept=".txt" style="display: none;">
            <div style="font-size: 18px; margin-bottom: 15px;">üìÅ Glisse ton merged_logs.txt ici</div>
            <button onclick="document.getElementById('logFile').click()" 
                    style="padding: 12px 24px; background: #00ff88; color: black; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                OU choisis fichier
            </button>
        `;
        document.body.appendChild(uploadZone);

        ['dragover', 'dragenter'].forEach(event => {
            uploadZone.addEventListener(event, e => e.preventDefault());
        });
        
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) loadFile(file);
        });
        
        document.getElementById('logFile').addEventListener('change', e => loadFile(e.target.files[0]));

        function loadFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const stats = parseCombatLog(e.target.result);
                displayStats(stats);
                document.getElementById('raw-log').innerHTML = 
                    `<strong>‚úÖ ${Object.keys(stats).length} joueurs - ${Object.values(stats).reduce((a,b)=>a+b.total,0).toLocaleString()} d√©g√¢ts totaux</strong><br>
                     <div style="margin-top:10px">${e.target.result.split('\n').slice(-50).join('<br>')}</div>`;
            };
            reader.readAsText(file);
        }

        // DONN√âES D'EXEMPLE (tes logs)
        const sampleLogs = `CombatLogVersion,4
20251213-222806136,DamageDone,Rue prcise,955968982,727,0,0,kNormalHit,Nonogt,Calanthia
20251213-222816676,DamageDone,Coup de bouclier,963293328,7385,0,1,kNormalHit,Nonogt,Calanthia
20251213-222817037,DamageDone,Combat acharn,956175664,6662,0,1,kMinDamageByCriticalDecision,Nonogt,Calanthia
20251213-222841344,DamageDone,Boule de mana,950614913,1171,1,1,kMaxDamageByCriticalDecision,P0SIPLAY,Calanthia
20251213-222842157,DamageDone,Coup corrupteur,967072496,1543,0,0,kNormalHit,P0SIPLAY,Calanthia`;
        
        displayStats(parseCombatLog(sampleLogs));
    </script>
</body>
</html>
